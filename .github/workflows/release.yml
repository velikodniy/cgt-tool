name: Release

on:
  push:
    tags:
      - "v*"
  # Make this workflow reusable
  workflow_call:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.7.2)"
        required: true
        type: string
  # Manual trigger
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.7.2)"
        required: true
        type: string

env:
  # Use workflow_call input if available, otherwise use push tag
  RELEASE_TAG: ${{ inputs.tag || github.ref_name }}

jobs:
  test:
    name: Test
    uses: ./.github/workflows/test.yml
  build:
    name: Build Artifacts
    needs:
      - test
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl
          - aarch64-apple-darwin
          - x86_64-apple-darwin
          - x86_64-pc-windows-gnu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.tag || github.ref }}
      - name: Build for ${{ matrix.target }}
        uses: zijiren233/cargo-cross@v1
        with:
          targets: ${{ matrix.target }}
          profile: release
          package: cgt-cli
      - name: Generate SHA256 checksums
        uses: Solratic/checksum-action@v1
        with:
          pattern: target/${{ matrix.target }}/release/cgt-tool
          suffix: sha256
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: binaries-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/cgt-tool
            target/${{ matrix.target }}/release/cgt-tool.sha256
  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.tag || github.ref }}
      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: wasm32-unknown-unknown
      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
      - name: Build WASM
        run: |
          cd crates/cgt-wasm
          wasm-pack build --target web --release
      - name: Create tarball
        uses: somaz94/compress-decompress@v1
        with:
          command: compress
          source: ./crates/cgt-wasm/pkg/
          stripPrefix: ./crates/cgt-wasm/pkg
          format: tgz
          destfilename: cgt-tool-wasm-${{ env.RELEASE_TAG }}
      - name: Generate SHA256 checksums
        uses: Solratic/checksum-action@v1
        with:
          pattern: cgt-tool-wasm-${{ env.RELEASE_TAG }}.tgz
          suffix: sha256
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wasm-package
          path: |
            cgt-tool-wasm-${{ env.RELEASE_TAG }}.tgz
            cgt-tool-wasm-${{ env.RELEASE_TAG }}.sha256
  release:
    name: Create GitHub Release
    needs: [build, build-wasm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts/
      - run: |
          ls -R artifacts/
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            artifacts/*/release/cgt-tool*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(env.RELEASE_TAG, '-rc') || contains(env.RELEASE_TAG, '-beta') || contains(env.RELEASE_TAG, '-alpha') }}
  notify-tap:
    name: Notify Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TAP_REPO_TOKEN }}
          repository: velikodniy/homebrew-tap
          event-type: cgt-tool-release
          client-payload: '{"tag": "${{ env.RELEASE_TAG }}"}'
