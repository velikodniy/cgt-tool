name: Update FX Rates

on:
  # Run on the last Friday of each month at 10:00 UTC
  # HMRC publishes rates on the penultimate Thursday of each month
  schedule:
    - cron: "0 10 25-31 * 5" # Every Friday between 25th-31st
  # Make this workflow reusable
  workflow_call:
  # Manual trigger
  workflow_dispatch:

env:
  RATES_DIR: crates/cgt-money/resources/rates

jobs:
  update-rates:
    name: Update FX Rates
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new-version: ${{ steps.bump-version.outputs.new-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Download new rates
        id: download
        run: python3 scripts/download_fx_rates.py "$RATES_DIR" 2026 >> $GITHUB_OUTPUT
      - name: Bump version and create tag
        if: steps.download.outputs.has-new == 'true'
        id: bump-version
        run: |
          current=$(awk -F'"' '/^version = /{print $2; exit}' Cargo.toml)
          new_version="${current%.*}.$((${current##*.} + 1))"
          sed -i "s/^version = \"$current\"/version = \"$new_version\"/" Cargo.toml
          cargo update --workspace
          git add "$RATES_DIR"/*.xml Cargo.toml Cargo.lock
          git commit -m "chore: bump version to $new_version"
          git tag -a "v$new_version" -m "${{ steps.download.outputs.release-body }}"
          echo "new-version=$new_version" >> $GITHUB_OUTPUT
      - name: Push changes and tag
        if: steps.download.outputs.has-new == 'true'
        run: |
          git push origin main
          git push origin "v${{ steps.bump-version.outputs.new-version }}"
  trigger-release:
    name: Trigger Release
    needs: update-rates
    if: needs.update-rates.outputs.new-version != ''
    permissions:
      contents: write
    uses: ./.github/workflows/release.yml
    with:
      tag: v${{ needs.update-rates.outputs.new-version }}
    secrets: inherit
