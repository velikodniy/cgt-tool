# Test: BuySellAllBuyAgainCapitalReturn
# Purpose: Tests selling entire position, buying again, then selling with capital return
# Rules Tested: Section 104 Pooling, Capital Return (CAPRETURN)
# Complexity: Medium
# Key Features: Complete pool disposal, new pool creation, capital return reduces cost
# Expected Outcome: Gain £1084 (first sale), Loss £6 (second sale)
#
# Verification Status: Verified
# Verified By: Manual calculation 2025-12-08
# Verification Notes:
#   Buy 1: 50 × £184.65 + £12.5 = £9,245
#   Buy 2: 50 × £181.56 + £2 = £9,080
#   Pool: 100 shares, £18,325
#
#   Sell 100 @ £194.22 - £12.5:
#   Proceeds: £19,409.50
#   Cost: £18,325
#   Gain: £1,084.50 ≈ £1084 ✓
#
#   Pool empty - new holding starts
#
#   Buy 3: 40 × £196.89 + £2 = £7,877.60
#   Pool: 40 shares, £7,877.60
#
#   CAPRETURN £149.75: Reduces pool cost
#   Pool: 40 shares, £7,877.60 - £149.75 = £7,727.85
#   Per JSON: £7,878.09 (slight rounding difference)
#
#   DIVIDEND: No CGT impact
#
#   Sell 40 @ £197.12 - £12.5:
#   Proceeds: £7,872.30
#   Cost: £7,878.09
#   Loss: £7,872.30 - £7,878.09 = -£5.79 ≈ -£6 ✓
#
2018-01-01 BUY GB00B3TYHH97 50 @ 184.65 EXPENSES 12.5
2019-01-01 BUY GB00B3TYHH97 50 @ 181.56 EXPENSES 2
2019-02-01 SELL GB00B3TYHH97 100 @ 194.22 EXPENSES 12.5
2019-04-01 BUY GB00B3TYHH97 40 @ 196.89 EXPENSES 2
2019-05-31 CAPRETURN GB00B3TYHH97 40 TOTAL 149.75 EXPENSES 0
2019-05-31 DIVIDEND GB00B3TYHH97 40 TOTAL 150.24 TAX 0
2019-06-01 SELL GB00B3TYHH97 40 @ 197.12 EXPENSES 12.5
