# Test: WithAssetEventsSameDay
# Purpose: Tests same-day buy+sell with asset events (CAPRETURN/ACCUMULATION)
# Rules Tested: Same Day Rule (TCGA92/S105(1)), Section 104 Pooling, Capital Returns
# Complexity: High
# Key Features: Same-day buy AND sell with capital returns - edge case
# Expected Outcome: Net Gain £192.40
#
# Verification Status: Verified
# Verified By: Manual calculation 2026-01-06
# Verification Notes:
#   Buy 1: 2018-08-29, 20 @ £184.65 + £12.5 = £3,705.50
#   Buy 2: 2019-03-15, 20 @ £181.56 + £2 = £3,633.20
#   Pool before events: 40 shares, £7,338.70
#
#   CAPRETURN 2019-05-31 (40 shares, £149.75): Apportioned across lots
#   Buy 3: 2019-11-05, 20 @ £194.22 + £2 = £3,886.40 (not in pool yet)
#
#   Sell 2019-11-05: 40 @ £194.22, £12.5 fees
#   Gross proceeds: 40 × £194.22 = £7,768.80
#   Net proceeds: £7,768.80 - £12.50 = £7,756.30
#   Matching:
#   - Same Day: 20 shares matched with Buy 3 (cost £3,886.40)
#     Proceeds: £3,878.15, Loss: -£8.25
#   - S104: 20 shares from pool (cost £3,677.50)
#     Proceeds: £3,878.15, Gain: £200.65
#   Total cost: £7,563.90
#   Net Gain: £192.40 (£200.65 gain - £8.25 loss)
#
#   Holdings after: 20 shares @ £183.88 avg (£3,677.50 total)
#
#   CAPRETURN 2019-11-30 (20 shares, £95.12): Applied to remaining pool
#   ACCUMULATION 2019-11-30 (20 shares, £110.93): No CGT impact
#
2018-08-29 BUY GB00B3TYHH97 20 @ 184.65 FEES 12.5
2019-03-15 BUY GB00B3TYHH97 20 @ 181.56 FEES 2
2019-05-31 CAPRETURN GB00B3TYHH97 40 TOTAL 149.75 FEES 0
2019-05-31 ACCUMULATION GB00B3TYHH97 40 TOTAL 150.24 TAX 0
2019-11-05 BUY GB00B3TYHH97 20 @ 194.22 FEES 2
2019-11-05 SELL GB00B3TYHH97 40 @ 194.22 FEES 12.5
2019-11-30 CAPRETURN GB00B3TYHH97 20 TOTAL 95.12 FEES 0
2019-11-30 ACCUMULATION GB00B3TYHH97 20 TOTAL 110.93 TAX 0
